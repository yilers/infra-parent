var l=(g,u,c)=>new Promise((y,s)=>{var p=o=>{try{f(c.next(o))}catch(n){s(n)}},r=o=>{try{f(c.throw(o))}catch(n){s(n)}},f=o=>o.done?y(o.value):Promise.resolve(o.value).then(p,r);f((c=c.apply(g,u)).next())});import{dV as $,dU as O,a3 as C,d$ as h,cZ as D}from"./bootstrap-B0IOIL79.js";import{h as q,a as L,b as z,c as j}from"./index-KxAZzjzc.js";import{_ as G,c as U}from"./menu-drawer.vue_vue_type_script_setup_true_lang-Cpzn3hbV.js";import{_ as w}from"./table-action.vue_vue_type_style_index_0_lang-D0vDTAOO.js";import J from"./index-Bml6TPTK.js";import K from"./index-DrWjF7M-.js";import{m as P,aa as Y,b9 as x,ad as Z,b2 as E,j as d,bJ as m,ab as H,ac as Q,u as i,ai as k,bp as S,I as W}from"../jse/index-index-StHjciy-.js";import{u as X}from"./use-drawer-zBZwZnKb.js";import{e as R,f as ee,s as ae}from"./tree-Cp_w0kss.js";const pe=P({__name:"table",props:{platformType:{}},setup(g){const u=g,{hasAccessByRoles:c}=$(),y=Y(()=>c(["platformAdmin"])),s=x(""),p=x([]),r=x(!0),f={columns:U,height:"auto",keepSource:!0,pagerConfig:{enabled:!1},proxyConfig:{ajax:{query:()=>l(null,null,function*(){s.value="";const a=y.value?yield q(u.platformType):yield L(u.platformType),e=ae(a,"sortNumber","id");return p.value=e,r.value&&setTimeout(()=>T()),{records:e}})}},rowConfig:{keyField:"id",drag:!0},rowDragConfig:{trigger:"cell",isPeerDrag:!0,dragEndMethod({newRow:a,oldRow:e}){return a.parentId!==e.parentId?(D.warning("必须在相同层级内拖拽排序"),!1):a.operable===0||e.operable===0?(D.warning("该菜单不可操作"),!1):!0}},scrollY:{enabled:!0,gt:0},treeConfig:{parentField:"parentId",rowField:"id",transform:!0,reserve:!0},id:"system-menu-index"},[o,n]=O({gridOptions:f,gridEvents:{cellDblclick:a=>{const{row:e={}}=a;if(!(e!=null&&e.children))return;const t=e==null?void 0:e.expand;n.grid.setTreeExpand(e,!t),e.expand=!t},toggleTreeExpand:a=>{const{row:e={},expanded:t}=a;e.expand=t},rowDragend:t=>l(null,[t],function*({newRow:a,oldRow:e}){if(!a||!e){console.warn("拖拽行信息不完整，操作取消");return}yield h(n,()=>l(null,null,function*(){try{yield z({fid:String(a.id),sid:String(e.id)}),r.value=!1,yield n.query(),r.value=!0,D.success("排序更新成功")}catch(V){n.grid.loadData(p.value),console.error(V)}}))})}}),[A,b]=X({connectedComponent:G,destroyOnClose:!0});function _(){b.setData({device:u.platformType}).open()}function I(a){b.setData(a).open()}function B(a){const{id:e}=a;b.setData({parentId:e,device:u.platformType}).open()}function F(a){return l(this,null,function*(){yield h(n,()=>l(null,null,function*(){yield j(a.id),r.value=!1,yield n.query(),r.value=!0}))})}function v(a){var e;R(n.grid.getData(),t=>t.expand=a),(e=n.grid)==null||e.setAllTreeExpand(a)}function T(){n.grid.clearTreeExpand(),n.grid.getData().filter(t=>!t.parentId||t.parentId==="0").forEach(t=>{n.grid.setTreeExpand(t,!0)})}function M(){if(!s.value){n.grid.loadData(p.value),setTimeout(()=>T());return}const a=ee(p.value,s.value,"permissionName");n.grid.loadData(a),v(!0)}function N(){return l(this,null,function*(){yield h(n,()=>l(null,null,function*(){r.value=!1,yield n.query(),r.value=!0}))})}return(a,e)=>(E(),Z(W,null,[d(i(o),null,{"toolbar-actions":m(()=>[d(i(w),{actions:[{label:"新增",type:"primary",icon:"ant-design:plus-outlined",auth:["system:menu:add"],onClick:()=>_()}]},null,8,["actions"])]),"toolbar-tools":m(()=>[d(i(J),null,{default:m(()=>[d(i(K).Search,{value:s.value,"onUpdate:value":e[0]||(e[0]=t=>s.value=t),placeholder:"输入菜单名称搜索",style:{width:"240px"},onSearch:M,"allow-clear":""},null,8,["value"]),d(i(C),{onClick:e[1]||(e[1]=t=>v(!1))},{default:m(()=>[k(S(a.$t("pages.common.collapse")),1)]),_:1}),d(i(C),{onClick:e[2]||(e[2]=t=>v(!0))},{default:m(()=>[k(S(a.$t("pages.common.expand")),1)]),_:1})]),_:1})]),action:m(({row:t})=>[t.operable===1?(E(),H(i(w),{key:0,actions:[{label:"编辑",icon:"ant-design:edit-outlined",auth:["system:menu:edit"],onClick:I.bind(null,t)},{label:"新增",type:"link",ifShow:t.permissionType!==2,icon:"ant-design:plus-outlined",size:"small",auth:["system:menu:add"],onClick:B.bind(null,t)}],"drop-down-actions":[{label:"删除",icon:"ant-design:delete-outlined",popConfirm:{title:"确定删除吗？",confirm:F.bind(null,t)},auth:["system:menu:delete"]}]},null,8,["actions","drop-down-actions"])):Q("",!0)]),_:1}),d(i(A),{onReload:N})],64))}});export{pe as _};
