var M=Object.defineProperty,T=Object.defineProperties;var z=Object.getOwnPropertyDescriptors;var G=Object.getOwnPropertySymbols;var F=Object.prototype.hasOwnProperty,J=Object.prototype.propertyIsEnumerable;var P=(d,u,t)=>u in d?M(d,u,{enumerable:!0,configurable:!0,writable:!0,value:t}):d[u]=t,h=(d,u)=>{for(var t in u||(u={}))F.call(u,t)&&P(d,t,u[t]);if(G)for(var t of G(u))J.call(u,t)&&P(d,t,u[t]);return d},p=(d,u)=>T(d,z(u));var N=(d,u,t)=>new Promise((k,x)=>{var f=s=>{try{l(t.next(s))}catch(b){x(b)}},I=s=>{try{l(t.throw(s))}catch(b){x(b)}},l=s=>s.done?k(s.value):Promise.resolve(s.value).then(f,I);l((t=t.apply(d,u)).next())});import{bj as U,dJ as H,dZ as W,dX as X,dK as V}from"./bootstrap-DjYyHEgg.js";import{h as Z}from"./cardType-DPMG7IpI.js";import{c as A,a as Q}from"./index-BiD7armX.js";import{m as Y,b9 as w,n as E,ab as D,b2 as $,u as L,bJ as ee,j as se}from"../jse/index-index-rmdNY63r.js";const ue=Y({__name:"choose-column-modal",props:{businessCategory:{default:""}},emits:["onSubmit"],setup(d,{expose:u,emit:t}){const k=d,x=t,f=w([]),I=w(!1),l=w([]),s=w([]),[b,R]=U({onOpenChange(a){return N(this,null,function*(){var g,e,c,i;const n=R.getData();I.value=(g=n==null?void 0:n.isUpdate)!=null?g:!1;const r=(c=(e=n==null?void 0:n.defaultCheckedLists)==null?void 0:e.map(o=>o.columnId))!=null?c:[];s.value=[...(i=n==null?void 0:n.defaultCheckedLists)!=null?i:[]],l.value=a?r:[],f.value=a?[...r]:[],a&&(yield E(),S.setGridOptions({checkboxConfig:{checkRowKeys:l.value}}))})},onConfirm(){return N(this,null,function*(){x("onSubmit",s.value),R.close()})}}),O=p(h({},Q),{collapsed:!0,commonConfig:{labelWidth:70}}),j=p(h({},A),{toolbarConfig:h({},A.toolbarConfig),editConfig:{mode:"cell",trigger:"click",beforeEditMethod:({row:a})=>l.value.includes(a.id)?/\{[^{}]+\}/.test(a.name)?(V.warning("变量列不能编辑"),!1):!0:(V.warning("只有选中的行才能编辑"),!1)},stripe:!0,border:!0,rowConfig:{isHover:!0,keyField:"id"},checkboxConfig:{highlight:!0,checkRowKeys:l.value},columnConfig:{resizable:!1},showOverflow:!1,exportConfig:{},height:"auto",keepSource:!0,pagerConfig:{},proxyConfig:{ajax:{query:(g,e)=>N(null,[g,e],function*({page:{currentPage:a,pageSize:n}},r){const c=h(h({current:a,size:n,businessCategory:k.businessCategory},k.businessCategory===X.Sale&&{type:W.Custom}),r),i=yield Z(c);return i.records=i.records.map(o=>{var y,C;const m=s.value.find(B=>B.id===o.id||B.columnId===o.id);if(!m)return p(h({},o),{sourceCategoryName:(y=o.sourceCategoryName)!=null?y:o.categoryName,sourceColumnName:(C=o.sourceColumnName)!=null?C:o.name});const _=/\{[^{}]+\}/.test(o.name||"");return p(h({},o),{name:_?o.name:m.name||m.columnName,categoryName:m.categoryName,sourceCategoryName:m.sourceCategoryName,sourceColumnName:m.sourceColumnName})}),i})}}}),q={checkboxChange(){l.value=v().ids,s.value=v().lists},checkboxAll(){l.value=v().ids,s.value=v().lists},"proxy-query":function({$grid:a}){E(()=>{var r,g;const n=a.getData();((r=s.value)!=null&&r.length||(g=l.value)!=null&&g.length)&&n.forEach(e=>{var c,i;if((c=s.value)!=null&&c.length){const o=s.value.find(m=>m.id===e.id||m.columnId===e.id);o!=null&&o.name&&a.reloadRow(e,p(h({},e),{name:o.name,categoryName:o.categoryName}))}(i=l.value)!=null&&i.includes(e.id)&&a.setCheckboxRow(e,!0)})})},editClosed({row:a,$grid:n}){if(l.value.includes(a.id)){const r=s.value.findIndex(g=>g.id===a.id||g.columnId===a.id);r!==-1&&(s.value[r]=p(h(h({},s.value[r]),a),{columnId:a.id}))}else n.setCheckboxRow(a,!0);l.value=v().ids,s.value=v().lists}},[K,S]=H({gridOptions:j,formOptions:O,gridEvents:q});function v(){const a=S.grid.getData(),n=S.grid.getCheckboxRecords(),r=n.map(e=>e.id);f.value=f.value.filter(e=>r.includes(e)||!a.some(c=>c.id===e)),r.forEach(e=>{if(!f.value.includes(e)){const c=n.find(o=>o.id===e);if(!c)return;const i=f.value.reduce((o,m,_)=>{const y=n.find(C=>C.id===m)||s.value.find(C=>C.id===m||C.columnId===m);return(y==null?void 0:y.categoryName)===c.categoryName?_:o},-1);i===-1?f.value.push(e):f.value.splice(i+1,0,e)}});const g=f.value.map(e=>{const c=n.find(i=>i.id===e);return c||s.value.find(i=>i.id===e||i.columnId===e)}).filter(Boolean);return console.error({ids:f.value,lists:g}),{ids:f.value,lists:g}}return u(R),(a,n)=>($(),D(L(b),{title:"选择",class:"h-[90%] w-[70%]","content-class":"h-[100%]"},{default:ee(()=>[se(L(K))]),_:1}))}});export{ue as _};
