var E=Object.defineProperty,R=Object.defineProperties;var K=Object.getOwnPropertyDescriptors;var S=Object.getOwnPropertySymbols;var P=Object.prototype.hasOwnProperty,j=Object.prototype.propertyIsEnumerable;var I=(n,a,r)=>a in n?E(n,a,{enumerable:!0,configurable:!0,writable:!0,value:r}):n[a]=r,D=(n,a)=>{for(var r in a||(a={}))P.call(a,r)&&I(n,r,a[r]);if(S)for(var r of S(a))j.call(a,r)&&I(n,r,a[r]);return n},M=(n,a)=>R(n,K(a));var N=(n,a,r)=>new Promise((v,i)=>{var p=c=>{try{g(r.next(c))}catch(m){i(m)}},x=c=>{try{g(r.throw(c))}catch(m){i(m)}},g=c=>c.done?v(c.value):Promise.resolve(c.value).then(p,x);g((r=r.apply(n,a)).next())});import{a as J}from"./index-C4NAiFfA.js";import{dL as U,dJ as Y,dK as q,a7 as H,bu as X}from"./bootstrap-DjYyHEgg.js";import{c as $,h as Q}from"./pageTableConfig-CJVVeSTk.js";import{_ as W}from"./choose-mapping-column.vue_vue_type_script_setup_true_lang-BYCmyJWS.js";import{f as Z}from"./mapping-BVKRu9Vr.js";import{m as ee,b9 as _,ab as oe,b2 as te,bJ as C,j as b,u as h,ae as re,ai as ae,n as se}from"../jse/index-index-rmdNY63r.js";import{u as ne}from"./use-drawer-CB92zaEG.js";import"./index-CovW7kLz.js";import"./contast-C3bEivmW.js";const le={class:"h-[600px] w-full"},ue=ee({__name:"edit-mapping-form",setup(n,{expose:a}){const r=_({}),v=_(),i=_({columnList:[]}),p=_(),[x,g]=U(D({showDefaultActions:!1},Z)),c={columns:[],customConfig:{immediate:!0,allowVisible:!1,allowFixed:!1,allowResizable:!1,showFooter:!1},toolbarConfig:{refresh:!1,resizable:!0},stripe:!0,border:!0,columnConfig:{drag:!0,resizable:!1},columnDragConfig:{trigger:"cell",isPeerDrag:!0},showOverflow:!0,height:"auto",keepSource:!0,pagerConfig:{enabled:!1},virtualYConfig:{enabled:!1},virtualXConfig:{enabled:!1},exportConfig:{},proxyConfig:{ajax:{query:()=>N(null,null,function*(){try{const e={pageCode:r.value.pageCode,find:"all"},t=yield Q(e);i.value.columnList=t;const o=A(t),l=k();return d.setGridOptions({columns:m(o)}),{records:l}}catch(e){return console.error("获取数据失败:",e),{records:[]}}})},sort:!0}};function m(e){return[...e]}const V={columnDragend({newColumn:e,oldColumn:t}){if(!e||!t){console.warn("拖拽列信息不完整，操作取消");return}const o=[...d.grid.getTableColumn().fullColumn];let l=[];const s=o.findIndex(u=>u.field===t.field),w=o.findIndex(u=>u.field===e.field);if(s===-1||w===-1)return;const[L]=o.splice(s,1);if(!L){console.warn("未找到拖拽列，操作取消");return}o.splice(w,0,L),l=o;const B=new Map(l.filter(u=>!["formattedTime","specs"].includes(u.field)).map((u,y)=>[u.field,y+1]));i.value.columnList=i.value.columnList.map(u=>M(D({},u),{sortNumber:B.get(u.columnKey)})).sort((u,y)=>u.sortNumber-y.sortNumber)}};function k(){return[{id:"1889502902455570434",timeStartStr:"2025年8月",leastActiveAmount:0,kpiAmount:0,dateProgress:0,doneAmount:0,gap:0,kpiAchievedStateStr:"完成",kpiDoneRate:0,targetGap:0,yearOnYear:0,yesterdayIncome:0,overdue:0}]}const[O,d]=Y({gridEvents:V,gridOptions:c}),[G,f]=ne({closeIconPlacement:"right",appendToMain:!0,footer:!0,destroyOnClose:!0,onOpenChange(e){var t,o;r.value=e?((t=f.getData())==null?void 0:t.record)||{}:{},v.value=e?(o=f.getData())==null?void 0:o.gridApi:null,g.setValues(r.value)},onConfirm(){return N(this,null,function*(){var e;f.lock();try{const t={pageCode:r.value.pageCode,columnList:i.value.columnList};yield $(t),q.success("保存成功"),(e=v.value)==null||e.reload(),f.close()}catch(t){console.error("保存失败:",t)}finally{f.unlock()}})}}),T=e=>{const t=A(e),o=k();d.setGridOptions({data:[]}),se(()=>{var l,s;d.setGridOptions({columns:m(t),data:o}),(l=d.grid)==null||l.refreshColumn(),(s=d.grid)==null||s.reloadData(o)})},z=()=>{p.value.setData({isUpdate:!1,defaultCheckedLists:i.value.columnList}),p.value.open()},F=e=>{const t=[...e];t.forEach((o,l)=>{o.columnName=o.customName||o.columnName,o.sortNumber=l+1,o.columnId=o.columnId||o.id}),i.value.columnList=t,T(i.value.columnList)};function A(e){if(e.length===0)return[];e=e.filter(s=>s.columnSetting!==2);const t=s=>({field:s.columnKey,title:s.columnName,width:170,visible:!0,sortNumber:s.sortNumber}),o=[...e].sort((s,w)=>s.sortNumber-w.sortNumber),l=[];return o.forEach(s=>{l.push(t(s))}),l}return a(f),(e,t)=>(te(),oe(h(G),{class:"w-full",title:"编辑列"},{default:C(()=>[b(h(x),{class:"h-full w-full"},{list:C(()=>[re("div",le,[b(h(O),{class:"w-[100%]"},{"toolbar-tools":C(()=>[b(h(H),{class:"mr-2",type:"primary",onClick:z},{icon:C(()=>[b(h(J),{class:"mr-1 inline-block size-4"})]),default:C(()=>[t[0]||(t[0]=ae(" 选择列 ",-1))]),_:1})]),_:1})])]),_:1}),b(W,{"page-code":r.value.pageCode,ref_key:"chooseColumnModalRef",ref:p,onOnSubmit:F},null,8,["page-code"])]),_:1}))}}),ve=X(ue,[["__scopeId","data-v-43938b0f"]]);export{ve as default};
