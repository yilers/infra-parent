var ee=Object.defineProperty,ae=Object.defineProperties;var te=Object.getOwnPropertyDescriptors;var F=Object.getOwnPropertySymbols;var M=Object.prototype.hasOwnProperty,Y=Object.prototype.propertyIsEnumerable;var B=(l,o,s)=>o in l?ee(l,o,{enumerable:!0,configurable:!0,writable:!0,value:s}):l[o]=s,x=(l,o)=>{for(var s in o||(o={}))M.call(o,s)&&B(l,s,o[s]);if(F)for(var s of F(o))Y.call(o,s)&&B(l,s,o[s]);return l},N=(l,o)=>ae(l,te(o));var $=(l,o)=>{var s={};for(var e in l)M.call(l,e)&&o.indexOf(e)<0&&(s[e]=l[e]);if(l!=null&&F)for(var e of F(l))o.indexOf(e)<0&&Y.call(l,e)&&(s[e]=l[e]);return s};var S=(l,o,s)=>new Promise((e,n)=>{var f=p=>{try{m(s.next(p))}catch(u){n(u)}},b=p=>{try{m(s.throw(p))}catch(u){n(u)}},m=p=>p.done?e(p.value):Promise.resolve(p.value).then(f,b);m((s=s.apply(l,o)).next())});import{bD as _,dL as se,bj as le,dK as q,dX as d,a7 as j}from"./bootstrap-DjYyHEgg.js";import{a as oe,b as re}from"./cardType-DPMG7IpI.js";import{b as ne,a as ce}from"./business-Uwvf-GkQ.js";import{_ as ue}from"./choose-custom-modal.vue_vue_type_script_setup_true_lang-B5kymVJs.js";import{s as ie}from"./contast-C3bEivmW.js";import{v as me,l as T,o as pe,b as A}from"./useSchemas-BvOAAoUm.js";import{b9 as h,m as de,b$ as ye,u as i,aa as fe,ad as be,b2 as ge,j as y,bJ as g,ae as he,aQ as E,ai as U}from"../jse/index-index-rmdNY63r.js";import R,{InputGroup as J}from"./index-EkdSFYQU.js";function ve(){const l=h("");return{getSchemas:s=>(l.value=s,[{fieldName:"id",label:"ID",component:"Input",dependencies:{show:!1,triggerFields:["id"]}},{fieldName:"categoryId",label:"所属分类Id",component:"Input",defaultValue:"0",dependencies:{show:!1,triggerFields:["categoryId"]}},{fieldName:"categoryName",label:"所属分类",component:"Input",componentProps:{placeholder:"请输入所属分类",allowClear:!0,class:"w-80"},formItemClass:"col-span-12",help:"汇总项目名+号连接"},{fieldName:"name",label:"名称",component:"Input",componentProps:{placeholder:"请输入名称",allowClear:!0,class:"w-80"},help:"当字段值为变量时，需输入`{ }`",formItemClass:"col-span-12",rules:_().min(1,{message:"请输入名称"}).max(50,{message:"最多输入50个字符"}),dependencies:{componentProps:(e,n)=>({onChange:f=>{/\{[^{}]+\}/.test(e.name||"")&&["proportion","sumByYear","yearOverYear"].includes(e.calcWay)?n.setFieldValue("extra.subtract",e.extra.subtract===void 0?0:e.extra.subtract):n.setFieldValue("extra.subtract",void 0)}}),triggerFields:["name"]}},{fieldName:"valueType",component:"Select",componentProps:{allowClear:!1,placeholder:"请选择",showSearch:!1,class:"w-80",options:me},defaultValue:"number",formItemClass:"col-span-12",rules:"required",label:"数据类型",help:"当字段值为比率时，显示`%`"},{fieldName:"calcWay",component:"Select",componentProps:{allowClear:!1,placeholder:"请选择汇总方式",showSearch:!1,class:"w-80",options:ie.filter(e=>e.value!=="sum")},formItemClass:"col-span-12",rules:"required",label:"汇总方式",dependencies:{componentProps:(e,n)=>({onChange:f=>{l.value=e.calcWay,n.setFieldValue("wayValue",void 0),n.setFieldValue("extra.denominator",void 0),/\{[^{}]+\}/.test(e.name||"")&&["proportion","sumByYear","yearOverYear"].includes(e.calcWay)?n.setFieldValue("extra.subtract",0):n.setFieldValue("extra.subtract",void 0)}}),triggerFields:["calcWay"]}},{fieldName:"wayValue",component:"Input",componentProps:{placeholder:"请选择",allowClear:!0,class:"w-60"},formItemClass:"col-span-12",label:()=>T[l.value]||T.default,dependencies:{if(e){return["categorySum","customSum","proportion","sumByYear","yearOverYear"].includes(e.calcWay)},rules(e){const n=T[e.calcWay]||T.default;return _({required_error:`请选择${n}`}).nonempty(`请选择${n}`)},triggerFields:["calcWay"]}},{fieldName:"extra.denominator",label:"总体值",component:"Input",componentProps:{placeholder:"请选择",allowClear:!0,class:"w-60"},formItemClass:"col-span-12",dependencies:{if(e){return["proportion"].includes(e.calcWay)},rules(){return _({required_error:"请选择总体值"}).nonempty("请选择总体值")},triggerFields:["calcWay"]}},{fieldName:"extra.subtract",label:"汇总参数",component:"InputNumber",componentProps:{placeholder:"请输入汇总参数",allowClear:!0,class:"w-60",max:10,min:0},formItemClass:"col-span-12",dependencies:{if(e){return/\{[^{}]+\}/.test(e.name||"")&&["proportion","sumByYear","yearOverYear"].includes(e.calcWay)},rules(e){return/\{[^{}]+\}/.test(e.name||"")?"required":null},triggerFields:["calcWay","name"]}},{component:"RadioGroup",componentProps:{buttonStyle:"solid",options:[{label:"是",value:1},{label:"否",value:0}],optionType:"button"},defaultValue:1,fieldName:"summation",rules:"required",label:"是否合计"}]),calcWay:l}}const Se={class:"common-form"},Oe=de({__name:"form",setup(l,{expose:o}){const s=h(""),e=h({}),n=h(!1),f=h(),b=h([]),m=h(),[p,u]=se({showDefaultActions:!1}),{getSchemas:G}=ve(),D=()=>{var a;const t={[d.Sale]:A.schema,[d.Operation]:pe.schema,[d.Summary]:G((a=e.value.calcWay)!=null?a:"")};if(u.setState({schema:t[s.value]||A.schema}),s.value===d.Sale){const r=[{componentProps:{options:b.value},fieldName:"categoryId"}];u.updateSchema(r)}u.setValues(e.value)},[K,C]=le({destroyOnClose:!0,onOpenChange(t){return S(this,null,function*(){var a,r;if(t){const c=C.getData()||{};s.value=(a=c.businessCategory)!=null?a:"",n.value=(r=c.isUpdate)!=null?r:!1,e.value=ye(c.record||{}),L(c.record),f.value=c.gridApi,b.value=c.categories||[],D()}else e.value={},f.value=null})},onConfirm(){return S(this,null,function*(){var t;try{const{valid:a}=yield u.validate();if(!a)return;C.lock(!0);const r=yield u.getValues(),c=yield Q(r);yield X(c),q.success("保存成功"),(t=f.value)==null||t.query(),C.close()}catch(a){z(a)}finally{C.lock(!1)}})}}),L=t=>{if(Object.keys(e.value).length>0&&(t!=null&&t.extra))try{const a=typeof t.extra=="string"?JSON.parse(t.extra):t.extra;Object.assign(e.value,{extra:a})}catch(a){e.value.extra={}}};function Q(t){return S(this,null,function*(){var I,w,P;const v=t,{extra:a}=v,r=$(v,["extra"]),c=N(x(N(x({},r),{categoryId:(I=t.categoryId)!=null?I:"0"}),((w=e.value)==null?void 0:w.id)&&{id:e.value.id}),{businessCategory:ce(i(s)),businessType:t.businessType||ne(i(s))});if(s.value===d.Sale&&(c.categoryName=t.categoryId?(P=b.value.find(V=>V.value===t.categoryId))==null?void 0:P.label:""),s.value===d.Summary){const{subtract:V,denominator:W}=a,k=x(x({},V!=null&&{subtract:V}),W&&{denominator:W});c.extra=Object.keys(k).length>0?JSON.stringify(k):""}return c})}function X(t){return S(this,null,function*(){var r;yield((r=e.value)!=null&&r.id?oe:re)(t)})}function z(t){q.error(t instanceof Error?t.message:"保存失败，请检查网络或联系管理员")}const O=t=>S(null,null,function*(){const a=yield u.getValues(),r=t.includes(".")?(()=>{var w;const[v,I]=t.split(".");return((w=a==null?void 0:a[v])==null?void 0:w[I])||""})():(a==null?void 0:a[t])||"",c=r?r.split(",").map(v=>v.trim()):[];m.value.setData({isUpdate:!1,defaultCheckedIds:c,formValues:a,fieldName:t}),m.value.open()}),H=(t,a)=>{u.setFieldValue(a,t)},Z=fe(()=>{const t={[d.Sale]:"卡种",[d.Operation]:"数据指标",[d.Summary]:"汇总指标"},a=n.value?"编辑":"新增",r=t[i(s)]||"卡种";return`${a}${r}`});return o(C),(t,a)=>(ge(),be("div",null,[y(i(K),{title:Z.value,class:"w-300px"},{default:g(()=>[he("div",Se,[y(i(p),null,{wayValue:g(r=>[y(i(J),{compact:""},{default:g(()=>[y(i(R),E(r,{placeholder:"请选择",style:{width:"calc(100% - 200px)"},disabled:""}),null,16),y(i(j),{type:"primary",onClick:a[0]||(a[0]=c=>O("wayValue"))},{default:g(()=>[...a[2]||(a[2]=[U(" 选择 ",-1)])]),_:1})]),_:2},1024)]),"extra.denominator":g(r=>[y(i(J),{compact:""},{default:g(()=>[y(i(R),E(r,{placeholder:"请选择",style:{width:"calc(100% - 200px)"},disabled:""}),null,16),y(i(j),{type:"primary",onClick:a[1]||(a[1]=c=>O("extra.denominator"))},{default:g(()=>[...a[3]||(a[3]=[U(" 选择 ",-1)])]),_:1})]),_:2},1024)]),_:1})])]),_:1},8,["title"]),y(ue,{ref_key:"chooseCustomModalRef",ref:m,onOnSubmit:H,"business-category":s.value},null,8,["business-category"])]))}});export{Oe as _};
