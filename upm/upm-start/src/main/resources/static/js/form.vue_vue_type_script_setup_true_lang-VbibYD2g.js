var W=Object.defineProperty,J=Object.defineProperties;var z=Object.getOwnPropertyDescriptors;var F=Object.getOwnPropertySymbols;var H=Object.prototype.hasOwnProperty,X=Object.prototype.propertyIsEnumerable;var Q=(s,n,o)=>n in s?W(s,n,{enumerable:!0,configurable:!0,writable:!0,value:o}):s[n]=o,C=(s,n)=>{for(var o in n||(n={}))H.call(n,o)&&Q(s,o,n[o]);if(F)for(var o of F(n))X.call(n,o)&&Q(s,o,n[o]);return s},$=(s,n)=>J(s,z(n));var w=(s,n,o)=>new Promise((b,c)=>{var f=t=>{try{e(o.next(t))}catch(r){c(r)}},_=t=>{try{e(o.throw(t))}catch(r){c(r)}},e=t=>t.done?b(t.value):Promise.resolve(t.value).then(f,_);e((o=o.apply(s,n)).next())});import{u as Z,d as ee}from"./index-CwQ9Bea5.js";import{c as te,d as ae,i as oe}from"./dateTime-Ce6Ez397.js";import{_ as ne}from"./choose-custom-modal.vue_vue_type_script_setup_true_lang-CyxAfJ0r.js";import{b9 as v,ci as P,m as re,aa as se,ab as le,b2 as K,u as p,bJ as A,ae as y,j as h,ad as D,bb as q,bp as U,I as B,aQ as ue,ai as ie}from"../jse/index-index-rmdNY63r.js";import{bD as R,dL as de,dK as N,a7 as me}from"./bootstrap-DjYyHEgg.js";import M,{InputGroup as pe}from"./index-EkdSFYQU.js";import{u as ce}from"./use-drawer-CB92zaEG.js";function fe(){const s=v(null),n=v([]),o=v([]),b={wrapperClass:"grid-cols-12",commonConfig:{formItemClass:"col-span-12",labelWidth:160,hideRequiredMark:!0},schema:[{fieldName:"year",label:"选择合同年份",component:"DatePicker",componentProps:{picker:"year",format:"YYYY",valueFormat:"YYYY",class:"w-full",disabledDate:e=>e.isAfter(P().endOf("year")),onChange:e=>{s.value=e||null}},rules:"required",dependencies:{trigger(e,t){e.year||t.setFieldValue("year",void 0),t.setFieldValue("date",[]),n.value=[],o.value=[]},triggerFields:["year"]}},{fieldName:"date",label:"选择时间跨度",component:"RangePicker",componentProps:{picker:"month",format:"YYYY-MM",valueFormat:"YYYY-MM",class:"w-full",separator:"至",disabledDate:e=>{if(!s.value)return!0;const t=P().year(s.value).startOf("year"),r=P().year(Number(s.value)+1).endOf("year");return e.isBefore(t)||e.isAfter(r)}},dependencies:{trigger(e,t){if(e.date&&e.date.length===2){const r=P(e.date[0]),V=P(e.date[1]);n.value=te(r,V),o.value=ae(r,V)}},triggerFields:["date"]},rules:"required"},{fieldName:"name",label:"合同名称",component:"Input",rules:"required",componentProps:{placeholder:"请输入合同名称",allowClear:!0}},{fieldName:"yearActiveRate",label:"年度保底激活比例（%）",component:"Input",defaultValue:"100",componentProps:{type:"number"},rules:R().min(1,{message:"请输入年度保底激活比例"}).refine(e=>Number(e)>=.01&&Number(e)<=100,{message:"比例必须在0.01-100之间"}).refine(e=>/^\d+(?:\.\d{1,6})?$/.test(e),{message:"最多支持小数点后6位"})},{fieldName:"seasonActiveRate",label:"季度保底激活比例（%）",component:"Input",defaultValue:"100",componentProps:{type:"number"},rules:R().min(1,{message:"请输入季度保底激活比例"}).refine(e=>Number(e)>=.01&&Number(e)<=100,{message:"比例必须在0.01-100之间"}).refine(e=>/^\d+(?:\.\d{1,6})?$/.test(e),{message:"最多支持小数点后6位"})},{fieldName:"monthActiveRate",label:"月度保底激活比例（%）",component:"Input",defaultValue:"100",componentProps:{type:"number"},rules:R().min(1,{message:"请输入月度保底激活比例"}).refine(e=>Number(e)>=.01&&Number(e)<=100,{message:"比例必须在0.01-100之间"}).refine(e=>/^\d+(?:\.\d{1,6})?$/.test(e),{message:"最多支持小数点后6位"})},{fieldName:"columnValue",label:"已完成GMV",component:"Input",rules:"required",componentProps:{placeholder:"请选择",allowClear:!0,class:"w-60"}},{fieldName:"totalKpiQuota",label:"年度KPI额度",component:"Input",componentProps:{type:"number"},rules:R().min(1,{message:"请输入年度KPI额度"})},{fieldName:"quarterKpiQuota",label:"季度KPI额度",component:""},{fieldName:"monthKpiQuota",label:"月度KPI额度",component:""}]},[c,f]=de(C({showDefaultActions:!1},b));return{kpiForm:c,formApi:f,quarterKPILists:n,monthKPILists:o,updateInfo:e=>w(null,null,function*(){s.value=e.year,yield f.setFieldValue("year",e.year),yield f.setFieldValue("date",e.date),e.listKpiQuota.forEach(t=>{n.value.forEach(r=>{t.type==="season"&&t.timeStart===r.timeStart&&(r.kpiAmount=t.kpiAmount,r.id=t.id)}),o.value.forEach(r=>{t.type==="month"&&t.timeStart===r.timeStart&&(r.kpiAmount=t.kpiAmount,r.id=t.id)})})})}}const ve={class:"common-form"},be={class:"flex max-w-[700px] flex-wrap"},ge={class:"mb-2 text-center"},ye={class:"flex max-w-[700px] flex-wrap"},he={class:"mb-2 text-center"},xe=re({__name:"form",setup(s,{expose:n}){const o=v({}),b=v(!1),c=v(),f=v(),{kpiForm:_,formApi:e,quarterKPILists:t,monthKPILists:r,updateInfo:V}=fe(),E=se(()=>c.value==="add"?"新增":c.value==="view"?"查看":"编辑"),[L,d]=ce({appendToMain:!0,footer:!0,destroyOnClose:!0,onOpenChange(a){var u,l,m,i,I,x;e.updateSchema([{fieldName:"year",componentProps:{disabled:!1}},{fieldName:"date",componentProps:{disabled:!1}}]),a&&(b.value=(l=(u=d.getData())==null?void 0:u.isUpdate)!=null?l:!1,o.value=a?((m=d.getData())==null?void 0:m.record)||{}:{},f.value=a?(i=d.getData())==null?void 0:i.gridApi:null,c.value=(x=(I=d.getData())==null?void 0:I.type)!=null?x:"add",e.setValues(o.value),d.setState({footer:d.getData().type!=="view"}),b.value&&O(),b.value&&e.updateSchema([{fieldName:"year",componentProps:{disabled:!0}},{fieldName:"date",componentProps:{disabled:!0}}]))},onConfirm(){return w(this,null,function*(){var u,l,m;if((yield e.validate()).valid)try{const i=yield e.getValues();if(!oe(i.date[0],i.date[1])){N.error("所选日期范围超过12个月，请检查");return}if(t.value.some(g=>!g.kpiAmount)||r.value.some(g=>!g.kpiAmount)){N.error("请检查季度KPI额度与月度KPI额度是否填写完整");return}const I=/^\d{1,13}(?:\.\d{1,4})?$/,x=t.value.find(g=>{const k=String(g.kpiAmount);return k.length>17||!I.test(k)}),G=r.value.find(g=>{const k=String(g.kpiAmount);return k.length>17||!I.test(k)});if(x){N.error("季度KPI额度最多支持小数点后4位，长度最大17位");return}if(G){N.error("月度KPI额度最多支持小数点后4位，长度最大17位");return}d.lock();const S=$(C({id:((u=o.value)==null?void 0:u.id)||null},i),{dateStart:i.date[0],dateEnd:i.date[1],listKpiQuota:[...t.value,...r.value]});delete S.date,yield((l=o.value)!=null&&l.id?Z:ee)(S),N.success("保存成功"),(m=f.value)==null||m.reload(),d.close()}finally{d.unlock()}})}}),O=()=>w(null,null,function*(){var u;const a=C({},(u=d.getData())==null?void 0:u.record);a.year=`${a.year}`,a.date=[a.dateStart,a.dateEnd],a.yearActiveRate=`${a.yearActiveRate}`,a.seasonActiveRate=`${a.seasonActiveRate}`,a.monthActiveRate=`${a.monthActiveRate}`,a.totalKpiQuota=`${a.totalKpiQuota}`,yield e.setValues(a),V(a)}),Y=v(),T=()=>w(null,null,function*(){const a=yield e.getValues(),u=a.columnValue?a.columnValue.split(",").map(l=>l.trim()):[];Y.value.setData({isUpdate:!1,defaultCheckedIds:u}),Y.value.open()}),j=a=>{e.setFieldValue("columnValue",a)};return n(d),(a,u)=>(K(),le(p(L),{class:"w-[800px]",title:E.value},{default:A(()=>[y("div",ve,[h(p(_),null,{columnValue:A(l=>[h(p(pe),{compact:""},{default:A(()=>[h(p(M),ue(l,{placeholder:"请选择",style:{width:"calc(100% - 200px)"}}),null,16),h(p(me),{type:"primary",onClick:u[0]||(u[0]=m=>T())},{default:A(()=>[...u[1]||(u[1]=[ie(" 选择 ",-1)])]),_:1})]),_:2},1024)]),quarterKpiQuota:A(()=>[y("div",be,[(K(!0),D(B,null,q(p(t),(l,m)=>(K(),D("div",{key:m,class:"mb-4 mr-4 w-full max-w-[100px]"},[y("div",ge,U(l.name),1),y("div",null,[h(p(M),{value:l.kpiAmount,"onUpdate:value":i=>l.kpiAmount=i,type:"number"},null,8,["value","onUpdate:value"])])]))),128))])]),monthKpiQuota:A(()=>[y("div",ye,[(K(!0),D(B,null,q(p(r),(l,m)=>(K(),D("div",{key:m,class:"mb-4 mr-4 w-full max-w-[100px]"},[y("div",he,U(l.name),1),y("div",null,[h(p(M),{value:l.kpiAmount,"onUpdate:value":i=>l.kpiAmount=i,type:"number"},null,8,["value","onUpdate:value"])])]))),128))])]),_:1})]),h(ne,{ref_key:"chooseCustomModalRef",ref:Y,onOnSubmit:j},null,512)]),_:1},8,["title"]))}});export{xe as _};
