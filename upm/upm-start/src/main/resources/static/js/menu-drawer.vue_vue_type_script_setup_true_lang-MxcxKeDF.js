var i=(_,C,u)=>new Promise((y,f)=>{var w=o=>{try{h(u.next(o))}catch(v){f(v)}},l=o=>{try{h(u.throw(o))}catch(v){f(v)}},h=o=>o.done?y(o.value):Promise.resolve(o.value).then(w,l);h((u=u.apply(_,C)).next())});import{dz as P,dL as R,e4 as U}from"./bootstrap-DjYyHEgg.js";import{h as E}from"./index-BMGH9Kr9.js";import{h as G,a as O}from"./index-DpFkAyCC.js";import{M as j}from"./menu-select-table-RWiO7UhU.js";import{k as z,e as J}from"./index-BWhM0zNP.js";import{m as K}from"./index-DazI-itC.js";import{m as W,b9 as p,aa as A,b$ as X,u as c,n as $,ab as F,b2 as M,bJ as S,j as q,ae as H}from"../jse/index-index-rmdNY63r.js";import{u as Q}from"./use-drawer-CB92zaEG.js";import{s as Y,l as Z}from"./tree-DTIvVT2i.js";const ee={class:"h-[600px] w-full"},me=W({__name:"menu-drawer",emits:["reload"],setup(_,{emit:C}){const u=C,y=p(),f=p([]),w=p(!1),l=p({}),{hasAccessByRoles:h}=P(),o=A(()=>h(["platformAdmin"])),v=A(()=>"关联菜单"),m=p(""),b=p([]),[g,s]=R({commonConfig:{componentProps:{class:"w-full"},formItemClass:"col-span-1"},layout:"vertical",schema:K(),showDefaultActions:!1,wrapperClass:"grid-cols-2 gap-x-4",handleValuesChange(e,a){N(e,a)}}),[B,d]=Q({onClosed:T,onConfirm:D,destroyOnClose:!0,onOpenChange(e){return i(this,null,function*(){if(!e)return null;d.lock();const{id:a}=d.getData();w.value=!!a;const t=yield z({platformId:a});l.value={id:a,menuIds:t,menuCheckStrictly:!0},s.setValues(l.value),yield x(),yield V(),d.unlock()})}});function D(){return i(this,null,function*(){var e,a,t;try{d.lock(!0);const{valid:r}=yield s.validate();if(!r)return;const I=(t=(a=(e=y.value)==null?void 0:e.getCheckedKeys)==null?void 0:a.call(e))!=null?t:[],n=X(yield s.getValues()),k={platformId:n.id,menuIdList:I,device:n.device};yield J(k),u("reload"),d.close()}catch(r){console.error(r)}finally{d.lock(!1)}})}function T(){return i(this,null,function*(){yield s.resetForm()})}function x(){return i(this,null,function*(){var e,a;try{const t=yield E();b.value=t,m.value=((e=t[0])==null?void 0:e.code)||"",s.updateSchema([{componentProps:{options:t.map(r=>({label:r.name,value:r.code}))},fieldName:"device"}]),s.setFieldValue("device",((a=t[0])==null?void 0:a.code)||"")}catch(t){}})}function V(){return i(this,null,function*(){const a=(yield c(o)?G(c(m)):O(c(m))).filter(n=>n.permissionType!==2&&!U.some(k=>n.component.startsWith(k)||n.menuUrl===k)),t=Y(a,"sortNumber","id");f.value=Z(t,{id:"id",pid:"parentId"});const r=new Set(t.map(n=>n.parentId).filter(Boolean));l.value.menuIds=l.value.menuIds.filter(n=>!r.has(n)),yield $();const I=w.value?l.value.menuIds:[];yield s.setFieldValue("menuIds",I)})}function L(e){s.setFieldValue("menuCheckStrictly",e)}const N=(e,a)=>i(null,null,function*(){a[0]==="device"&&c(m)!==e.device&&(m.value=e.device,yield s.setFieldValue("menuIds",[]),yield V())});return(e,a)=>(M(),F(c(B),{title:v.value,class:"w-[800px]"},{default:S(()=>[q(c(g),null,{menuIds:S(t=>[H("div",ee,[(M(),F(c(j),{ref_key:"menuSelectRef",ref:y,"checked-keys":t.value,association:c(s).form.values.menuCheckStrictly,menus:f.value,key:m.value,"has-permission-type2":!1,"onUpdate:association":L},null,8,["checked-keys","association","menus"]))])]),_:1})]),_:1},8,["title"]))}});export{me as _};
