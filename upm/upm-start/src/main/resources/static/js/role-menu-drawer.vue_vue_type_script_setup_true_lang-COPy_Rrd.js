var j=Object.defineProperty,z=Object.defineProperties;var G=Object.getOwnPropertyDescriptors;var V=Object.getOwnPropertySymbols;var J=Object.prototype.hasOwnProperty,K=Object.prototype.propertyIsEnumerable;var g=(n,t,a)=>t in n?j(n,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):n[t]=a,b=(n,t)=>{for(var a in t||(t={}))J.call(t,a)&&g(n,a,t[a]);if(V)for(var a of V(t))K.call(t,a)&&g(n,a,t[a]);return n},A=(n,t)=>z(n,G(t));var d=(n,t,a)=>new Promise((C,v)=>{var k=i=>{try{w(a.next(i))}catch(y){v(y)}},u=i=>{try{w(a.throw(i))}catch(y){v(y)}},w=i=>i.done?C(i.value):Promise.resolve(i.value).then(k,u);w((a=a.apply(n,t)).next())});import{dz as $,et as q}from"./bootstrap-DjYyHEgg.js";import{h as E}from"./index-BMGH9Kr9.js";import{h as H,a as Q}from"./index-DpFkAyCC.js";import{c as W,g as X}from"./index-DphJOICZ.js";import{M as Y}from"./menu-select-table-RWiO7UhU.js";import{m as Z}from"./data-I_kBbuuX.js";import{m as ee,b9 as h,aa as S,b$ as ae,u as l,n as te,ab as D,b2 as F,bJ as B,j as se,ae as oe}from"../jse/index-index-rmdNY63r.js";import{u as ne}from"./use-drawer-CB92zaEG.js";import{s as ce,l as ie}from"./tree-DTIvVT2i.js";const re={class:"h-[600px] w-full"},Ce=ee({__name:"role-menu-drawer",emits:["reload"],setup(n,{emit:t}){const a=t,C=h(),v=h([]),k=h(!1),u=h({}),{hasAccessByRoles:w}=$(),i=S(()=>w(["platformAdmin"])),y=S(()=>"分配菜单权限"),p=h(""),M=h([]),[x,c]=q({commonConfig:{componentProps:{class:"w-full"},formItemClass:"col-span-1"},layout:"vertical",schema:Z(),showDefaultActions:!1,wrapperClass:"grid-cols-2 gap-x-4",handleValuesChange(e,s){O(e,s)}}),[T,f]=ne({onClosed:R,onConfirm:L,destroyOnClose:!0,onOpenChange(e){return d(this,null,function*(){if(!e)return null;f.lock();const{id:s}=f.getData();k.value=!!s;const o=yield W(s);u.value=A(b({},o),{menuCheckStrictly:!0}),c.setValues(u.value),yield N(),yield I(),f.unlock()})}});function L(){return d(this,null,function*(){var e,s,o;try{f.lock(!0);const{valid:r}=yield c.validate();if(!r)return;const m=(o=(s=(e=C.value)==null?void 0:e.getCheckedKeys)==null?void 0:s.call(e))!=null?o:[],_=ae(yield c.getValues()),U={roleId:_.id,permissionIdList:m,device:_.device};yield X(U),a("reload"),f.close()}catch(r){console.error(r)}finally{f.lock(!1)}})}function R(){return d(this,null,function*(){yield c.resetForm()})}function N(){return d(this,null,function*(){var e,s;try{const o=yield E();M.value=o,p.value=((e=o[0])==null?void 0:e.code)||"",c.updateSchema([{componentProps:{options:o.map(r=>({label:r.name,value:r.code}))},fieldName:"device"}]),c.setFieldValue("device",((s=o[0])==null?void 0:s.code)||"")}catch(o){}})}function I(){return d(this,null,function*(){const e=yield l(i)?H(l(p)):Q(l(p)),s=ce(e,"sortNumber","id");v.value=ie(s,{id:"id",pid:"parentId"});const o=new Set(s.map(m=>m.parentId).filter(Boolean));u.value.menuIds=u.value.relationPermissionList.filter(m=>!o.has(m.id)).map(m=>m.id)||[],yield te();const r=k.value?u.value.menuIds:[];yield c.setFieldValue("menuIds",r)})}function P(e){c.setFieldValue("menuCheckStrictly",e)}const O=(e,s)=>d(null,null,function*(){s[0]==="device"&&l(p)!==e.device&&(p.value=e.device,yield c.setFieldValue("menuIds",[]),yield I())});return(e,s)=>(F(),D(l(T),{title:y.value,class:"w-[800px]"},{default:B(()=>[se(l(x),null,{menuIds:B(o=>[oe("div",re,[(F(),D(l(Y),{ref_key:"menuSelectRef",ref:C,"checked-keys":o.value,association:l(c).form.values.menuCheckStrictly,menus:v.value,key:p.value,"onUpdate:association":P},null,8,["checked-keys","association","menus"]))])]),_:1})]),_:1},8,["title"]))}});export{Ce as _};
