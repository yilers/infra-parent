var M=(b,l,a)=>new Promise((i,n)=>{var m=r=>{try{T(a.next(r))}catch(v){n(v)}},I=r=>{try{T(a.throw(r))}catch(v){n(v)}},T=r=>r.done?i(r.value):Promise.resolve(r.value).then(m,I);T((a=a.apply(b,l)).next())});import{dq as ne,dx as q,bo as le,bA as ie,bu as ue}from"./bootstrap-DjYyHEgg.js";import{k as ce}from"./index-CwQ9Bea5.js";import{_ as ve}from"./fallback.vue_vue_type_script_setup_true_lang-CaaeY5iC.js";import{m as Q,ad as B,b2 as h,aR as $,u as g,cf as fe,bc as W,j as K,ag as de,bJ as N,b9 as s,aa as P,w as F,v as me,x as pe,ab as G,ac as x,ai as he}from"../jse/index-index-rmdNY63r.js";import{R as ge}from"./rotate-cw-Dzdn7gja.js";const be=Q({name:"Loading",__name:"loading",props:{class:{},minLoadingTime:{},spinning:{type:Boolean},text:{}},setup(b){const l=b;return(a,i)=>(h(),B("div",{class:$(g(fe)("relative min-h-20",l.class))},[W(a.$slots,"default"),K(g(ne),{"min-loading-time":l.minLoadingTime,spinning:l.spinning,text:l.text},de({_:2},[a.$slots.icon?{name:"icon",fn:N(()=>[W(a.$slots,"icon")]),key:"0"}:void 0]),1032,["min-loading-time","spinning","text"])],2))}}),Te={class:"relative size-full overflow-hidden bg-background"},_e=["src"],ye=["src"],Ie=25e3,Se=15e3,ke=3e3,Le=1e4,Ae=Q({__name:"iframe-tab",props:{activeTab:{},link:{},attachParams:{},hasAllShopIds:{type:Boolean,default:!1},isKpiBigScreen:{type:Boolean,default:!1}},setup(b,{expose:l}){const a=b,i=s(!0),n=s(!1),m=s(),I=q(),T=le(),r=s([]),v=s(0),u=s(),c=s(),p=s(1),S=s(""),C=s(""),O=s(0),w=s(0),_=s(!1),y=s(!1),k=s(!1),U=s(!1),D=s(void 0),R=P(()=>r.value.length===0?null:r.value[v.value]),X=P(()=>{var e;return(e=R.value)==null?void 0:e.id}),Z=()=>{var j;const e=((j=a.link)==null?void 0:j.trim())||"";if(!e)return"";const t=ae.value;if(t.length===0)return e;const o={};t.forEach(re=>{const{name:H,value:oe}=re;o[H]=ee(H,oe)}),console.error("----当前url参数----",o);const A=JSON.stringify(o),d=btoa(A),se=e.includes("?")?"&":"?",Y=`${e}${se}attachParams=${d}`;return console.error("----iframeUrl----",Y),Y},ee=(e,t)=>{var o,A;if(t!=="[]"&&t!=="{}")return t;switch(e){case"CONTRACTID":{const d=(o=R.value)==null?void 0:o.id;return d?[d]:[]}case"SHOPID":{if(a.isKpiBigScreen){const d=(A=R.value)==null?void 0:A.shopId;return d?[d]:[]}return a.hasAllShopIds?I.getAllShopIds():[I.selectedShopId]}case"token":return`Bearer ${T.accessToken}`;default:return t}},ae=P(()=>{if(!a.attachParams)return[];try{return Array.isArray(a.attachParams)?a.attachParams:JSON.parse(a.attachParams)}catch(e){return console.error("解析 attachParams 失败:",e),[]}}),f=(e=!1)=>{u.value&&(clearTimeout(u.value),u.value=void 0),c.value&&(clearTimeout(c.value),c.value=void 0);const t=Z();e?(S.value=t,p.value=1,i.value=!0,_.value=!1,y.value=!1):(k.value=!0,p.value===1?(y.value=!1,C.value=t,w.value++):(_.value=!1,S.value=t,O.value++)),L(),m.value=setTimeout(()=>{(i.value||k.value)&&z()},Se)},V=e=>{L(),e===p.value?(i.value=!1,n.value=!1,e===1?_.value=!0:y.value=!0,E()):(c.value&&clearTimeout(c.value),c.value=setTimeout(()=>{e===1?_.value=!0:y.value=!0,p.value=e,k.value=!1,n.value=!1,E()},ke))},z=()=>{L(),i.value=!1,k.value=!1,n.value=!0,E(Le)},E=(e=Ie)=>{!a.isKpiBigScreen||r.value.length<=1||(u.value&&clearTimeout(u.value),u.value=setTimeout(()=>{v.value=(v.value+1)%r.value.length},e))},L=()=>{m.value&&(clearTimeout(m.value),m.value=void 0)},J=()=>{n.value=!1,f(!0)};F([()=>a.activeTab,()=>a.link],()=>{f(!0)}),F(X,e=>{if(a.isKpiBigScreen&&e!==void 0){if(e===D.value)return;D.value=e,U.value?f(!1):(f(!0),U.value=!0)}});const te=()=>M(null,null,function*(){try{const{getAllShopIds:e}=q(),t=e(),o=yield ce({shopIdList:t});console.error("--所有合同数据---",o),r.value=o||[],r.value.length===0&&f(!0)}catch(e){console.error("获取KPI合同列表失败:",e),f(!0)}});return me(()=>{a.isKpiBigScreen?te():f(!0)}),pe(()=>{L(),u.value&&clearInterval(u.value),c.value&&clearTimeout(c.value)}),l({reload:J}),(e,t)=>(h(),B("div",Te,[n.value?(h(),G(g(ve),{key:0,status:"500",title:"报表加载失败",description:"报表内容无法正常加载，请稍后重试",class:"z-50 bg-background"},{action:N(()=>[K(g(ie),{size:"lg",onClick:J},{default:N(()=>[K(g(ge),{class:"mr-2 size-4"}),t[2]||(t[2]=he(" 重新加载 ",-1))]),_:1})]),_:1})):x("",!0),i.value&&!n.value?(h(),G(g(be),{key:1,spinning:"",text:"正在加载...",class:"absolute inset-0 z-40 flex items-center justify-center bg-background"})):x("",!0),S.value?(h(),B("iframe",{key:O.value,src:S.value,class:$(["absolute inset-0 size-full border-0 transition-opacity duration-1000 ease-in-out",[p.value===1?"z-10":"z-0",_.value?"opacity-100":"opacity-0"]]),frameborder:"0",scrolling:"auto",onLoad:t[0]||(t[0]=o=>V(1)),onError:z},null,42,_e)):x("",!0),C.value?(h(),B("iframe",{key:w.value,src:C.value,class:$(["absolute inset-0 size-full border-0 transition-opacity duration-1000 ease-in-out",[p.value===2?"z-10":"z-0",y.value?"opacity-100":"opacity-0"]]),frameborder:"0",scrolling:"auto",onLoad:t[1]||(t[1]=o=>V(2)),onError:z},null,42,ye)):x("",!0)]))}}),Pe=ue(Ae,[["__scopeId","data-v-c565725d"]]);export{Pe as I};
