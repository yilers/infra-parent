var l=(_,k,u)=>new Promise((y,f)=>{var w=o=>{try{h(u.next(o))}catch(v){f(v)}},i=o=>{try{h(u.throw(o))}catch(v){f(v)}},h=o=>o.done?y(o.value):Promise.resolve(o.value).then(w,i);h((u=u.apply(_,k)).next())});import{dz as R,dL as U,e4 as P}from"./bootstrap-DjYyHEgg.js";import{h as E}from"./index-BMGH9Kr9.js";import{h as G,a as O}from"./index-DpFkAyCC.js";import{M as j}from"./menu-select-table-RWiO7UhU.js";import{d as z,e as J}from"./index-BWhM0zNP.js";import{m as K}from"./index-CrMcuxT_.js";import{m as W,b9 as p,aa as b,b$ as X,u as c,n as $,ab as A,b2 as B,bJ as F,j as q,ae as H}from"../jse/index-index-rmdNY63r.js";import{u as Q}from"./use-drawer-CB92zaEG.js";import{s as Y,l as Z}from"./tree-DTIvVT2i.js";const ee={class:"h-[600px] w-full"},de=W({__name:"menu-drawer",emits:["reload"],setup(_,{emit:k}){const u=k,y=p(),f=p([]),w=p(!1),i=p({}),{hasAccessByRoles:h}=R(),o=b(()=>h(["platformAdmin"])),v=b(()=>"关联菜单"),d=p(""),M=p([]),[S,s]=U({commonConfig:{componentProps:{class:"w-full"},formItemClass:"col-span-1"},layout:"vertical",schema:K(),showDefaultActions:!1,wrapperClass:"grid-cols-2 gap-x-4",handleValuesChange(e,a){N(e,a)}}),[g,m]=Q({onClosed:T,onConfirm:D,destroyOnClose:!0,onOpenChange(e){return l(this,null,function*(){if(!e)return null;m.lock();const{id:a}=m.getData();w.value=!!a;const t=yield z({brandId:a});i.value={id:a,menuIds:t,menuCheckStrictly:!0},s.setValues(i.value),yield x(),yield V(),m.unlock()})}});function D(){return l(this,null,function*(){var e,a,t;try{m.lock(!0);const{valid:r}=yield s.validate();if(!r)return;const I=(t=(a=(e=y.value)==null?void 0:e.getCheckedKeys)==null?void 0:a.call(e))!=null?t:[],n=X(yield s.getValues()),C={brandId:n.id,menuIdList:I,device:n.device};yield J(C),u("reload"),m.close()}catch(r){console.error(r)}finally{m.lock(!1)}})}function T(){return l(this,null,function*(){yield s.resetForm()})}function x(){return l(this,null,function*(){var e,a;try{const t=yield E();M.value=t,d.value=((e=t[0])==null?void 0:e.code)||"",s.updateSchema([{componentProps:{options:t.map(r=>({label:r.name,value:r.code}))},fieldName:"device"}]),s.setFieldValue("device",((a=t[0])==null?void 0:a.code)||"")}catch(t){}})}function V(){return l(this,null,function*(){const a=(yield c(o)?G(c(d)):O(c(d))).filter(n=>n.permissionType!==2&&!P.some(C=>n.component.startsWith(C)||n.menuUrl===C)),t=Y(a,"sortNumber","id");f.value=Z(t,{id:"id",pid:"parentId"});const r=new Set(t.map(n=>n.parentId).filter(Boolean));i.value.menuIds=i.value.menuIds.filter(n=>!r.has(n)),yield $();const I=w.value?i.value.menuIds:[];yield s.setFieldValue("menuIds",I)})}function L(e){s.setFieldValue("menuCheckStrictly",e)}const N=(e,a)=>l(null,null,function*(){a[0]==="device"&&c(d)!==e.device&&(d.value=e.device,yield s.setFieldValue("menuIds",[]),yield V())});return(e,a)=>(B(),A(c(g),{title:v.value,class:"w-[800px]"},{default:F(()=>[q(c(S),null,{menuIds:F(t=>[H("div",ee,[(B(),A(c(j),{ref_key:"menuSelectRef",ref:y,"checked-keys":t.value,association:c(s).form.values.menuCheckStrictly,menus:f.value,key:d.value,"has-permission-type2":!1,"onUpdate:association":L},null,8,["checked-keys","association","menus"]))])]),_:1})]),_:1},8,["title"]))}});export{de as _};
