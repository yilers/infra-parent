var Se=Object.defineProperty,Ie=Object.defineProperties;var Le=Object.getOwnPropertyDescriptors;var R=Object.getOwnPropertySymbols;var oe=Object.prototype.hasOwnProperty,se=Object.prototype.propertyIsEnumerable;var re=(f,p,l)=>p in f?Se(f,p,{enumerable:!0,configurable:!0,writable:!0,value:l}):f[p]=l,v=(f,p)=>{for(var l in p||(p={}))oe.call(p,l)&&re(f,l,p[l]);if(R)for(var l of R(p))se.call(p,l)&&re(f,l,p[l]);return f},y=(f,p)=>Ie(f,Le(p));var A=(f,p)=>{var l={};for(var i in f)oe.call(f,i)&&p.indexOf(i)<0&&(l[i]=f[i]);if(f!=null&&R)for(var i of R(f))p.indexOf(i)<0&&se.call(f,i)&&(l[i]=f[i]);return l};var z=(f,p,l)=>new Promise((i,F)=>{var T=g=>{try{_(l.next(g))}catch(k){F(k)}},u=g=>{try{_(l.throw(g))}catch(k){F(k)}},_=g=>g.done?i(g.value):Promise.resolve(g.value).then(T,u);_((l=l.apply(f,p)).next())});import{a as Ne,b as Fe}from"./index-C4NAiFfA.js";import{dL as Te,dJ as ke,dK as $,a7 as ae,bu as De}from"./bootstrap-DjYyHEgg.js";import{m as Oe,b9 as C,n as ne,ab as Ae,b2 as $e,bJ as S,j as x,u as I,ae as Ve,ai as ie,ci as Ge}from"../jse/index-index-rmdNY63r.js";import{a as Re,b as Ye}from"./shopRechargeSales-BtQUcM40.js";import{d as Ee}from"./pageTableConfig-CJVVeSTk.js";import{u as ze}from"./useTransForm-WoUBoxq3.js";import{_ as Be}from"./choose-column-modal.vue_vue_type_script_setup_true_lang-DrSJQOBt.js";import{_ as Pe}from"./choose-row-modal.vue_vue_type_script_setup_true_lang-BP5uthtB.js";import{f as je}from"./index-BiD7armX.js";import{u as Ue}from"./use-drawer-CB92zaEG.js";import"./business-Uwvf-GkQ.js";import"./contast-C3bEivmW.js";import"./dateTime-Ce6Ez397.js";import"./cardType-DPMG7IpI.js";const We={class:"h-[600px] w-full"},L="_1",N="_2",Je=Oe({__name:"edit-table-form",setup(f,{expose:p}){const l=C([]),i=C({}),F=C(),T=C(""),u=C({columnList:[],rowList:[]}),_=C(),g=C(),[k,B]=Te(v({showDefaultActions:!1},je)),P={date:{field:"formattedTime",title:"日期",width:130},specs:{field:"specs",title:"规格",width:160,dragSort:!0,align:"left"}},{transformColumns:j,transformRowData:U,rowspanMethod:le}=ze(),ce={columns:[],customConfig:{immediate:!0,allowVisible:!1,allowFixed:!1,allowResizable:!1,showFooter:!1,visibleMethod({column:e}){return!["formattedTime","specs"].includes(e.field)}},toolbarConfig:{refresh:!1,resizable:!0},stripe:!0,border:!0,rowConfig:{drag:!0,isHover:!0},rowDragConfig:{trigger:"cell",dragEndMethod({newRow:e,oldRow:t}){return e.formattedTime!==t.formattedTime?($.warning("该数据不允许拖拽调整顺序"),!1):!0}},columnConfig:{drag:!0,resizable:!1},columnDragConfig:{trigger:"cell",isPeerDrag:!0,visibleMethod({column:e}){const t=String(e.field||"");return!(["formattedTime","specs"].includes(t)||D(t)||O(t))},dragEndMethod({newColumn:e,oldColumn:t}){var c,n;const s=new Set(["formattedTime","specs"]),r=String((c=e==null?void 0:e.field)!=null?c:""),o=String((n=t==null?void 0:t.field)!=null?n:"");if(s.has(r)||s.has(o))return $.warning("该数据不允许拖拽调整顺序"),!1;if(e!=null&&e.children||t!=null&&t.children)return!0;if(D(o)||O(o))return $.warning("同比/环比列不允许拖拽调整顺序"),!1;const a=d=>d.replace(/_(1|2)$/,"");return a(o)===a(r)?($.warning("同组列（基础/同比/环比）不允许调整相对顺序"),!1):!0}},showOverflow:!0,height:"auto",keepSource:!0,pagerConfig:{enabled:!1},virtualYConfig:{enabled:!1},virtualXConfig:{enabled:!1},exportConfig:{},spanMethod:le,proxyConfig:{ajax:{query:()=>z(null,null,function*(){try{const e={tabCode:i.value.tabCode,year:Ge().year()},t={tabCode:i.value.tabCode},[s=[],r=[]]=yield Promise.all([Re(e),Ye(t)]),o=J(s);u.value={columnList:o,rowList:r};const a=j(o),c=K(o,r),n=U(r,c);return Array.isArray(n)&&Q(n,o),b.setGridOptions({columns:q(a)}),{records:n}}catch(e){return console.error("获取数据失败:",e),{records:[]}}})},sort:!0}},D=e=>String(e||"").endsWith(L),O=e=>String(e||"").endsWith(N),W=e=>{const t=String(e||"");return D(t)?t.slice(0,-L.length):O(t)?t.slice(0,-N.length):t};function Y(){return{needYoY:l.value.includes("yearOverYear"),needMoM:l.value.includes("monthOnMonth")}}const J=(e=[])=>{const{needYoY:t,needMoM:s}=Y();return!t&&!s?e:e.filter(r=>!D(r.columnId)&&!O(r.columnId))};function X(e,t){const s=t?"同比":"环比",r=t?L:N;return{title:`${s}`,field:`${e.field}${r}`,width:e.width||120}}function H(e,t,s){return e.flatMap(r=>{var a;if((a=r.children)!=null&&a.length)return[y(v({},r),{children:H(r.children,t,s)})];const o=[r];return t&&o.push(X(r,!0)),s&&o.push(X(r,!1)),o})}function ue(e,t){return!(!e&&!t)}function q(e){const t=[P.date,P.specs],{needYoY:s,needMoM:r}=Y();if(!ue(s,r))return[...t,...e];const a=H(e,s,r);return[...t,...a]}const de={columnDragend({newColumn:e,oldColumn:t}){var d,h;if(!e||!t){console.warn("拖拽列信息不完整，操作取消");return}const s=new Set(["formattedTime","specs"]),r=String((d=e.field)!=null?d:""),o=String((h=t.field)!=null?h:"");if(s.has(r)||s.has(o)||D(o)||O(o))return!1;const a=[...b.grid.getTableColumn().fullColumn],n=(e==null?void 0:e.children)||(t==null?void 0:t.children)?fe(a,t,e):pe(a,t,e);!n||n.length===0||me(n)},rowDragend({newRow:e,oldRow:t}){if(!e||!t){console.warn("拖拽行信息不完整，操作取消");return}const s=[...b.grid.getFullData()],r=new Map(s.map((a,c)=>[a.rowCode,c+1])),o=u.value.rowList.map(a=>y(v({},a),{sortNumber:r.get(a.rowCode)})).sort((a,c)=>a.sortNumber-c.sortNumber);u.value.rowList=o}};function fe(e,t,s){var c;const r=t.children?e.filter(n=>n.parentId===t.id):[t];if(r.length===0)return console.warn("没有可移动的列"),null;let o=-1;if(s.children){const n=(c=s.children[0])==null?void 0:c.id;o=e.findIndex(d=>d.id===n)}if(o===-1&&(o=e.findIndex(n=>n.id===s.id)),o===-1)return null;const a=e.filter(n=>!r.some(d=>d.id===n.id));return[...a.slice(0,o),...r,...a.slice(o)]}function pe(e,t,s){if(l.value.length===0){const m=e.findIndex(E=>E.field===t.field),w=e.findIndex(E=>E.field===s.field);if(m===-1||w===-1)return null;const[te]=e.splice(m,1);return te?(e.splice(w,0,te),e):null}const r=W(String(t.field||""));if(!r)return null;const a=[r,`${r}${L}`,`${r}${N}`].map(m=>e.findIndex(w=>w.field===m)).filter(m=>m!==-1).sort((m,w)=>m-w).map(m=>e[m]);if(a.length===0)return null;const c=new Set(a.map(m=>m.id)),n=String(s.field||""),d=W(n),h=[d,`${d}${L}`,`${d}${N}`].map(m=>e.findIndex(w=>w.field===m)).filter(m=>m!==-1);if(h.length===0)return null;const G=Math.min(...h),Ce=Math.max(...h),Z=n===d?G:Ce+1,ee=e.filter(m=>!c.has(m.id));return[...ee.slice(0,Z),...a,...ee.slice(Z)]}function me(e){var s;const t=new Map(e.filter(r=>!["formattedTime","specs"].includes(r.field)).map((r,o)=>[r.field,o+1]));u.value.columnList=u.value.columnList.map(r=>y(v({},r),{sortNumber:t.get(r.columnId)})).sort((r,o)=>r.sortNumber-o.sortNumber),((s=l.value)==null?void 0:s.length)>0&&V(u.value.columnList,u.value.rowList)}function K(e,t){return[{id:"1889502902455570434",type:"day",time:"2024-08-01 00:00:00",remark:"",difference:0,status:2,createTime:"2025-02-12 10:32:52",updateTime:"2025-02-12 17:12:41",dataMap:t.reduce((s,r)=>(s[r.rowCode]=e.map(o=>({[o.columnId]:"0"})),s),{})}]}const[ge,b]=ke({gridEvents:de,gridOptions:ce}),[he,M]=Ue({closeIconPlacement:"right",appendToMain:!0,footer:!0,destroyOnClose:!0,onOpenChange(e){var t,s,r,o,a;T.value=(s=(t=M.getData())==null?void 0:t.businessCategory)!=null?s:"",i.value=e?((r=M.getData())==null?void 0:r.record)||{}:{},F.value=e?(o=M.getData())==null?void 0:o.gridApi:null,e?(ve(i.value),l.value=Array.isArray((a=i.value.extra)==null?void 0:a.comparison)?i.value.extra.comparison:[],i.value.extra||(i.value.extra={}),i.value.extra.comparison=l.value,B.setValues(i.value),l.value.length>0&&ne(()=>{V(u.value.columnList,u.value.rowList)})):(b.setGridOptions({columns:[],data:[]}),B.setValues({}))},onConfirm(){return z(this,null,function*(){var e;M.lock(!0);try{const t=u.value.columnList.map(n=>{var d=n,{id:a}=d,c=A(d,["id"]);return/\{[^{}]+\}/.test(c.sourceColumnName||"")?y(v({},c),{columnName:c.sourceColumnName}):c}),s=J(t).map((a,c)=>y(v({},a),{sortNumber:c+1})),r=u.value.rowList.map(d=>{var h=d,{id:a,code:c}=h,n=A(h,["id","code"]);return n}),o={tabCode:i.value.tabCode,columnList:s,rowList:r};yield Ee(o),$.success("保存成功"),(e=F.value)==null||e.reload(),M.close()}catch(t){console.error("保存失败:",t)}finally{M.lock(!1)}})}}),ve=e=>{if(Object.keys(i.value).length>0&&(e!=null&&e.extra))try{const t=typeof e.extra=="string"?JSON.parse(e.extra):e.extra;Object.assign(i.value,{extra:t})}catch(t){i.value.extra={}}};function Q(e,t){const{needYoY:s,needMoM:r}=Y();if(!Array.isArray(e)||!Array.isArray(t)||!s&&!r)return;const o=[s?L:"",r?N:""].filter(Boolean);e.forEach(a=>{t.forEach(c=>{for(const n of o){const d=`${c.columnId}${n}`;a[d]===void 0&&(a[d]=0)}})})}function be(e,t){const s=j(e),r=K(e,t),o=U(t,r);return Q(o,e),{columns:q(s),data:o}}function we(e,t){b.setGridOptions({columns:e,data:t}),ne(()=>{var s,r;(s=b.grid)==null||s.refreshColumn(),(r=b.grid)==null||r.reloadData(t)})}const V=(e,t)=>{try{const{columns:s,data:r}=be(e,t);we(s,r)}catch(s){console.error("刷新表格数据失败:",s);try{b.setGridOptions({columns:[],data:[]})}catch(r){console.error("清空表格失败:",r)}}},ye=()=>{_.value.setData({isUpdate:!1,defaultCheckedLists:u.value.columnList}),_.value.open()},xe=e=>{const t=e.map((h,d)=>{var G=h,{code:s,calcWay:r,type:o,wayValue:a,operate:c}=G,n=A(G,["code","calcWay","type","wayValue","operate"]);return y(v({},n),{columnId:n.columnId||n.id,columnName:n.columnName||n.name,pageCode:i.value.code,sortNumber:d+1,frontShow:1})});u.value.columnList=t,t.length===0&&(u.value.rowList=[]),V(u.value.columnList,u.value.rowList)},_e=()=>{g.value.setData({isUpdate:!1,defaultCheckedLists:u.value.rowList}),g.value.open()},Me=e=>{const t=e.map((c,a)=>{var n=c,{operate:s,type:r}=n,o=A(n,["operate","type"]);return y(v({},o),{rowId:o.rowId||o.id,rowName:o.rowName||o.name,rowCode:o.rowCode||o.code,pageCode:i.value.code,sortNumber:a+1,frontShow:1})});u.value.rowList=t,V(u.value.columnList,u.value.rowList)};return p(M),(e,t)=>($e(),Ae(I(he),{class:"w-full",title:"编辑行列"},{default:S(()=>[x(I(k),{class:"h-full w-full"},{list:S(()=>[Ve("div",We,[x(I(ge),{class:"w-[100%]"},{"toolbar-tools":S(()=>[x(I(ae),{class:"mr-2",type:"primary",onClick:ye},{icon:S(()=>[x(I(Ne),{class:"mr-1 inline-block size-4"})]),default:S(()=>[t[0]||(t[0]=ie(" 选择列 ",-1))]),_:1}),x(I(ae),{class:"mr-2",type:"primary",onClick:_e},{icon:S(()=>[x(I(Fe),{class:"mr-1 inline-block size-4"})]),default:S(()=>[t[1]||(t[1]=ie(" 选择行 ",-1))]),_:1})]),_:1})])]),_:1}),x(Be,{"business-category":T.value,ref_key:"chooseColumnModalRef",ref:_,onOnSubmit:xe},null,8,["business-category"]),x(Pe,{"business-category":T.value,ref_key:"chooseRowModalRef",ref:g,onOnSubmit:Me},null,8,["business-category"])]),_:1}))}}),ct=De(Je,[["__scopeId","data-v-2695733a"]]);export{ct as default};
