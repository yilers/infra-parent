var ce=Object.defineProperty,ue=Object.defineProperties;var de=Object.getOwnPropertyDescriptors;var V=Object.getOwnPropertySymbols;var X=Object.prototype.hasOwnProperty,Z=Object.prototype.propertyIsEnumerable;var Q=(e,o,t)=>o in e?ce(e,o,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[o]=t,A=(e,o)=>{for(var t in o||(o={}))X.call(o,t)&&Q(e,t,o[t]);if(V)for(var t of V(o))Z.call(o,t)&&Q(e,t,o[t]);return e},W=(e,o)=>ue(e,de(o));var ee=(e,o)=>{var t={};for(var a in e)X.call(e,a)&&o.indexOf(a)<0&&(t[a]=e[a]);if(e!=null&&V)for(var a of V(e))o.indexOf(a)<0&&Z.call(e,a)&&(t[a]=e[a]);return t};var T=(e,o,t)=>new Promise((a,u)=>{var h=p=>{try{d(t.next(p))}catch(s){u(s)}},i=p=>{try{d(t.throw(p))}catch(s){u(s)}},d=p=>p.done?a(p.value):Promise.resolve(p.value).then(h,i);d((t=t.apply(e,o)).next())});import{U as pe}from"./index-C4NAiFfA.js";import{I as fe,bF as me,dy as ge,dK as I,dL as he,dM as _,dx as ve,bj as se,dJ as be,a7 as Y,bu as ye}from"./bootstrap-DjYyHEgg.js";import{UploadDragger as Ce}from"./index-ld-cT6bn.js";import{j as L,m as q,b9 as b,ad as E,b2 as z,ac as H,u as C,bJ as D,ae as F,bp as U,I as le,bb as re,aT as we,d9 as xe,ci as te,aa as ke,bF as Te,ab as N,be as ie,ai as j,bL as ne,n as ze,L as Se}from"../jse/index-index-rmdNY63r.js";import{a as Ie}from"./fileTransfer-p8-3apt7.js";import{f as Pe}from"./dateTime-Ce6Ez397.js";import{a as De,b as Fe,c as Le}from"./table-FRaKquww.js";import ae from"./index-CovW7kLz.js";import{u as Me}from"./useShopCheck-DKIjDUfz.js";var Oe={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M512.5 390.6c-29.9 0-57.9 11.6-79.1 32.8-21.1 21.2-32.8 49.2-32.8 79.1 0 29.9 11.7 57.9 32.8 79.1 21.2 21.1 49.2 32.8 79.1 32.8 29.9 0 57.9-11.7 79.1-32.8 21.1-21.2 32.8-49.2 32.8-79.1 0-29.9-11.7-57.9-32.8-79.1a110.96 110.96 0 00-79.1-32.8zm412.3 235.5l-65.4-55.9c3.1-19 4.7-38.4 4.7-57.7s-1.6-38.8-4.7-57.7l65.4-55.9a32.03 32.03 0 009.3-35.2l-.9-2.6a442.5 442.5 0 00-79.6-137.7l-1.8-2.1a32.12 32.12 0 00-35.1-9.5l-81.2 28.9c-30-24.6-63.4-44-99.6-57.5l-15.7-84.9a32.05 32.05 0 00-25.8-25.7l-2.7-.5c-52-9.4-106.8-9.4-158.8 0l-2.7.5a32.05 32.05 0 00-25.8 25.7l-15.8 85.3a353.44 353.44 0 00-98.9 57.3l-81.8-29.1a32 32 0 00-35.1 9.5l-1.8 2.1a445.93 445.93 0 00-79.6 137.7l-.9 2.6c-4.5 12.5-.8 26.5 9.3 35.2l66.2 56.5c-3.1 18.8-4.6 38-4.6 57 0 19.2 1.5 38.4 4.6 57l-66 56.5a32.03 32.03 0 00-9.3 35.2l.9 2.6c18.1 50.3 44.8 96.8 79.6 137.7l1.8 2.1a32.12 32.12 0 0035.1 9.5l81.8-29.1c29.8 24.5 63 43.9 98.9 57.3l15.8 85.3a32.05 32.05 0 0025.8 25.7l2.7.5a448.27 448.27 0 00158.8 0l2.7-.5a32.05 32.05 0 0025.8-25.7l15.7-84.9c36.2-13.6 69.6-32.9 99.6-57.5l81.2 28.9a32 32 0 0035.1-9.5l1.8-2.1c34.8-41.1 61.5-87.4 79.6-137.7l.9-2.6c4.3-12.4.6-26.3-9.5-35zm-412.3 52.2c-97.1 0-175.8-78.7-175.8-175.8s78.7-175.8 175.8-175.8 175.8 78.7 175.8 175.8-78.7 175.8-175.8 175.8z"}}]},name:"setting",theme:"filled"};function oe(e){for(var o=1;o<arguments.length;o++){var t=arguments[o]!=null?Object(arguments[o]):{},a=Object.keys(t);typeof Object.getOwnPropertySymbols=="function"&&(a=a.concat(Object.getOwnPropertySymbols(t).filter(function(u){return Object.getOwnPropertyDescriptor(t,u).enumerable}))),a.forEach(function(u){Re(e,u,t[u])})}return e}function Re(e,o,t){return o in e?Object.defineProperty(e,o,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[o]=t,e}var J=function(o,t){var a=oe({},o,t.attrs);return L(fe,oe({},a,{icon:Oe}),null)};J.displayName="SettingFilled";J.inheritAttrs=!1;const Ee=me("app-config",{state:()=>({}),actions:{$reset(){}},persist:[]});function _e(){return T(this,null,function*(){return ge.post("/file/getTempToken")})}const Ne={class:"flex justify-center"},$e={class:"ant-upload-hint"},Be={key:0,class:"mt-4"},Ae={class:"mb-1 text-sm text-gray-500"},Ve={class:"h-2 w-full rounded-full bg-gray-200"},je={class:"mt-2 text-sm text-gray-500"},Ye=q({__name:"upload-file",props:{uploadType:{default:"oss"},uploadFn:{},isAbnormal:{type:Boolean,default:!1},show:{type:Boolean},multiple:{type:Boolean,default:!1},extension:{default:".csv"},fileSize:{default:1e3},size:{default:1}},emits:["fileDataImport","setConfirmLoading","update:show"],setup(e,{expose:o,emit:t}){const a=e,u=t,h=b(!1),i=b([]),d=b(0),p=b([]);function s(c){return c.uploadType==="direct"}const f=(c,g)=>{if(c<p.value.length){const r=p.value[c];r&&(r.progress=g,d.value=p.value.reduce((l,n)=>l+n.progress,0)/p.value.length)}},w=c=>T(null,null,function*(){const g=yield _e(),r=[],l=c.map((n,m)=>n.originFileObj?new Promise((v,$)=>{xe(n.originFileObj,g,M=>{r.push({filePath:M,fileName:n.name}),v({filePath:M,fileName:n.name})},M=>{f(m,M*100)}).catch($)}):Promise.resolve({filePath:"",fileName:""}));return yield Promise.all(l),r}),x=c=>T(null,null,function*(){if(!s(a))throw new Error("当前上传类型不是 direct");if(!a.uploadFn)throw new Error("当 uploadType 为 direct 时，uploadUrl 是必需的");const g=[],r=c.map((l,n)=>{const m=l.originFileObj;if(!m)throw new Error("文件对象不存在");return a.uploadFn({file:m,fileType:m.type},v=>f(n,v)).then(v=>{var M,B;if(f(n,100),a.isAbnormal)return;const $={filePath:(M=v.url)!=null?M:"",fileName:(B=l.name)!=null?B:""};return g.push($),$})});return yield Promise.all(r),g}),S=()=>T(null,null,function*(){if(i.value.length===0){I.error("请先上传文件"),u("setConfirmLoading",!1);return}if(!h.value){h.value=!0;try{p.value=i.value.map(g=>({uid:g.uid,progress:0}));const c=yield a.uploadType==="oss"?w(i.value):x(i.value);u("fileDataImport",c),a.isAbnormal&&I.success("数据导入成功")}catch(c){I.error("文件上传失败，请重试"),i.value=[],u("setConfirmLoading",!1)}finally{h.value=!1,d.value=0,p.value=[]}}}),R=c=>{i.value=i.value.filter(g=>g.uid!==c.uid)},y=c=>{c.file.status==="removed"&&(I.info(`${c.file.name} 已移除`),R(c.file))},k=c=>{var n;const g=`.${(n=c.name.split(".").pop())==null?void 0:n.toLowerCase()}`;return a.extension.toLowerCase().split(",").includes(g)?c.size/1024/1024>=a.fileSize?(I.error(`文件大小不能超过${a.fileSize}MB!`),!1):i.value.length>=a.size?(I.error(`最多上传${a.size}个文件`),!1):(i.value.push({uid:Date.now().toString(),name:c.name,status:"done",originFileObj:c}),!1):(I.error(`只能上传 ${a.extension} 格式的文件`),!1)};return o({confirmUpload:S,cancel:()=>{i.value=[],h.value=!1,d.value=0}}),(c,g)=>(z(),E("div",null,[L(C(Ce),{accept:e.extension,"before-upload":k,"file-list":i.value,"max-count":e.size,multiple:e.multiple,name:"file",onChange:y},{default:D(()=>[F("p",Ne,[L(C(pe),{class:"text-white-500 size-8"})]),g[0]||(g[0]=F("p",{class:"ant-upload-text"},"点击或将文件拖拽到这里上传",-1)),F("p",$e,"支持扩展名："+U(e.extension),1)]),_:1},8,["accept","file-list","max-count","multiple"]),p.value.length>0?(z(),E("div",Be,[(z(!0),E(le,null,re(p.value,r=>{var l;return z(),E("div",{key:r.uid,class:"mb-2"},[F("div",Ae,U((l=i.value.find(n=>n.uid===r.uid))==null?void 0:l.name),1),F("div",Ve,[F("div",{style:we({width:`${r.progress}%`}),class:"h-2 rounded-full bg-blue-600 transition-all duration-300"},null,4)])])}),128)),F("div",je," 总进度: "+U(Math.floor(d.value))+"% ",1)])):H("",!0)]))}});function Ue({bizImportType:e,resetForm:o,onSuccess:t,onError:a,onFinally:u}){return{fileDataImport:i=>T(null,null,function*(){try{const d=i.map(f=>Ie(A({filePath:f.filePath,biz:C(e),fileName:f.fileName},o))),s=(yield Promise.all(d)).filter(Boolean).length;s===i.length?I.success("数据导入成功"):I.warning(`导入完成：${s}/${i.length} 个文件成功`),t==null||t()}catch(d){a==null||a(d)}finally{u==null||u()}})}}const qe={wrapperClass:"flex",commonConfig:{formItemClass:"col-span-12",labelWidth:70}};function Ge(){const e=b(null),o=Ee(),{importDateMap:t}=o,a=(s,f)=>{if(!s||!e.value)return;const{startTime:w,endTime:x}=Pe(s,f);e.value.setFieldValue("timeStart",w),e.value.setFieldValue("timeEnd",x)},u=[{component:"Select",componentProps:{allowClear:!0,placeholder:"请选择"},rules:"required",fieldName:"dateType",label:"报表粒度",dependencies:{trigger(s,f){return T(this,null,function*(){s.dateTime&&f.setFieldValue("dateTime",null)})},triggerFields:["dateType"]}},{fieldName:"dateTime",label:"选择日",component:"RangePicker",rules:"required",componentProps:{format:"YYYY-MM-DD",separator:"至",onChange:s=>a(s,_.Day)},dependencies:{if(s){return s.dateType===_.Day},triggerFields:["dateType"]}},{fieldName:"dateTime",label:"选择周",component:"DatePicker",rules:"required",componentProps:{picker:"week",format:s=>{const f=te(s).startOf("week"),w=te(s).endOf("week");return`${f.format("YYYY/MM/DD")} ~ ${w.format("YY/MM/DD")}`},onChange:s=>a(s,_.Week)},dependencies:{if(s){return s.dateType===_.Week},triggerFields:["dateType"]}},{fieldName:"dateTime",label:"选择月份",component:"RangePicker",rules:"required",componentProps:{picker:"month",format:"YYYY-MM",separator:"至",onChange:s=>a(s,_.Month)},dependencies:{if(s){return s.dateType===_.Month},triggerFields:["dateType"]}}],[h,i]=he(W(A({showDefaultActions:!1},qe),{schema:u})),d=s=>{var f;if(s){const w=(f=C(t).get(s))==null?void 0:f.reportType,x=[{componentProps:{options:w},defaultValue:w[0].value,fieldName:"dateType"}];i.updateSchema(x)}};return e.value=i,{Form:h,formApi:i,updateSchemas:d}}const nt=q({__name:"upload-form",props:{bizImportType:{default:""},isError:{type:Boolean,default:!1},extension:{default:".csv"},uploadFn:{type:Function,default:()=>Promise.resolve()},multiple:{type:Boolean,default:!1},size:{default:1}},setup(e,{expose:o}){const t=e,a=ke(()=>{const{selectedShopName:y}=ve();return`导入${y||""}数据`}),{Form:u,formApi:h,updateSchemas:i}=Ge(),d=b(),p=b();Te(()=>{t.bizImportType&&i(t.bizImportType)});const[s,f]=se({destroyOnClose:!0,confirmLoading:!1,closeOnClickModal:!1,closeOnPressEscape:!1,closable:!1,fullscreenButton:!1,onOpenChange(y){var k;d.value=y?(k=f.getData())==null?void 0:k.gridApi:null,y||(x(!1),p.value.cancel())},onConfirm(){return T(this,null,function*(){if(t.isError){w();return}const{valid:y}=yield h.validate();y&&w()})},onCancel(){f.close()}});function w(){x(!0),p.value.confirmUpload()}function x(y){f.setState({confirmLoading:y})}const S=y=>T(null,null,function*(){if(t.isError){d.value.reload(),f.close();return}const r=yield h.getValues(),{dateTime:O}=r,c=ee(r,["dateTime"]),{fileDataImport:g}=Ue({bizImportType:t.bizImportType,resetForm:c,onSuccess:()=>{d.value.reload()},onFinally:()=>{f.close()}});g(y)});return o(f),(y,k)=>(z(),N(C(s),{title:a.value},{default:D(()=>[e.isError?H("",!0):(z(),N(C(u),{key:0})),L(C(Ye),{ref_key:"child",ref:p,extension:e.extension,"is-abnormal":e.isError,multiple:e.multiple,size:e.size,"upload-fn":e.uploadFn,"upload-type":"direct",onFileDataImport:S,onSetConfirmLoading:x},null,8,["extension","is-abnormal","multiple","size","upload-fn"])]),_:1},8,["title"]))}}),We={class:"flex w-full justify-between"},He=q({__name:"choose-column-modal",props:{bizImportTypeList:{default:()=>[]}},setup(e,{expose:o}){var O,c;const t=e,a={toolbarConfig:{custom:!1,refresh:!1,resizable:!1,zoom:!1},columns:[{type:"checkbox",align:"left",width:60},{field:"headerName",title:"表头",editRender:{name:"input"}},{field:"headerAlias",title:"别名"},{field:"fieldType",title:"类型"},{field:"allowNull",title:"是否允许为空",formatter({cellValue:r}){return r===1?"是":"否"}}]},u=b([]),h=b(""),i=b([]),d=b([]);h.value=((c=(O=t.bizImportTypeList)==null?void 0:O[0])==null?void 0:c.bizCode)||"";const[p,s]=se({onOpenChange(r){var l,n,m;r&&(u.value=((l=t.bizImportTypeList)==null?void 0:l.filter(v=>!v.isError))||[],h.value=((m=(n=t.bizImportTypeList)==null?void 0:n[0])==null?void 0:m.bizCode)||"")},onConfirm(){return T(this,null,function*(){try{s.lock(!0);const r=S.grid.getData();r.forEach(l=>{l.checked=d.value.some(n=>n.id===l.id)?1:0}),yield De(r),I.success("保存成功"),s.close()}catch(r){I.error("保存失败")}finally{s.lock(!1)}})}}),f=W(A({},a),{toolbarConfig:A({},a.toolbarConfig),editConfig:{mode:"cell",trigger:"click",beforeEditMethod:({row:r})=>i.value.includes(r.id)?!0:(I.warning("只有选中的行才能编辑"),!1)},stripe:!0,border:!0,rowConfig:{isHover:!0,keyField:"id"},checkboxConfig:{highlight:!0,checkRowKeys:i.value,checkMethod({row:r}){return r.requiredHeader!==1}},columnConfig:{resizable:!1},showOverflow:!1,exportConfig:{},height:"auto",keepSource:!0,pagerConfig:{enabled:!1},proxyConfig:{ajax:{query:()=>T(null,null,function*(){const r=(yield Fe(h.value))||[],l=[],n=[];return r.forEach(m=>{m.checked===1&&(l.push(m.id),n.push(m))}),d.value=[...n],i.value=l,S.setGridOptions({checkboxConfig:{checkRowKeys:i.value}}),{records:r}})}}}),w={checkboxChange(){i.value=R().ids,d.value=R().lists},checkboxAll(){i.value=R().ids,d.value=R().lists},pageChange({$grid:r}){ze(()=>T(null,null,function*(){if(!r)return;yield r.commitProxy("query"),r.getData().filter(m=>{var v;return(v=i.value)==null?void 0:v.includes(m.id)}).forEach(m=>{r.setCheckboxRow(m,!0)})}))}},[x,S]=be({gridOptions:f,gridEvents:w});function R(){var B,K;const r=S.grid.getCheckboxReserveRecords(),l=S.grid.getCheckboxRecords(),n=S.grid.getData(),v=[...((B=i.value)==null?void 0:B.filter(P=>!n.some(G=>G.id===P)))||[],...r.map(P=>P.id),...l.map(P=>P.id)],M=[...(K=d.value)==null?void 0:K.filter(P=>!n.some(G=>G.id===P.id)),...r.map(P=>P),...l.map(P=>P)];return{ids:[...new Set(v)],lists:[...new Set(M)]}}const y=()=>{i.value=[],d.value=[],S.reload()},k=()=>T(null,null,function*(){yield Le(h.value),S.reload()});return o(s),(r,l)=>{const n=ie("access");return z(),N(C(p),{title:"选择",class:"h-[80%] w-[60%]","content-class":"h-[100%]"},{footer:D(()=>[ne((z(),E("div",We,[F("div",null,[L(C(Y),{type:"primary",onClick:l[2]||(l[2]=m=>k())},{default:D(()=>[...l[5]||(l[5]=[j("恢复默认",-1)])]),_:1})]),F("div",null,[L(C(Y),{onClick:l[3]||(l[3]=m=>C(s).close()),style:{"margin-right":"12px"}},{default:D(()=>[...l[6]||(l[6]=[j(" 取消 ",-1)])]),_:1}),L(C(Y),{type:"primary",onClick:l[4]||(l[4]=m=>C(s).onConfirm())},{default:D(()=>[...l[7]||(l[7]=[j("确定",-1)])]),_:1})])])),[[n,["basic:importValidation:edit"],"codes"]])]),default:D(()=>{var m;return[u.value.length>1?(z(),N(C(ae),{key:0,class:"w-[280px]",value:h.value,"onUpdate:value":l[0]||(l[0]=v=>h.value=v),"default-value":(m=u.value[0])==null?void 0:m.bizCode,onChange:l[1]||(l[1]=v=>y())},{default:D(()=>[(z(!0),E(le,null,re(u.value,v=>(z(),N(C(ae).Option,{key:v.id,value:v.bizCode},{default:D(()=>[j(U(v.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","default-value"])):H("",!0),L(C(x))]}),_:1})}}}),Je={class:"table-import-setting"},Ke=q({__name:"table-import-setting",props:{bizImportTypeList:{default:()=>[]}},setup(e){const o=b(),t=()=>{o.value.open()};return(a,u)=>{const h=ie("access");return z(),E("div",Je,[F("div",null,[ne((z(),N(C(Y),{onClick:u[0]||(u[0]=i=>t()),class:"set-button",title:"导入设置"},{icon:D(()=>[L(C(J))]),_:1})),[[h,["basic:importValidation:rules"],"codes"]])]),L(He,{"biz-import-type-list":e.bizImportTypeList,ref_key:"chooseRowModalRef",ref:o},null,8,["biz-import-type-list"])])}}}),Qe=ye(Ke,[["__scopeId","data-v-610e7010"]]);function ct(e){var y;const{importTypeList:o,defaultExtension:t=".csv",errorExtension:a=".xlsx",checkShop:u=!0}=e,{checkShopSelected:h}=Me(),i=b(o),d=b(((y=o.find(k=>!k.isError))==null?void 0:y.bizCode)||""),p=b(),s=b(!1),f=b(t),w=b(!1),x=b(1);return{bizImportType:d,bizImportTypeList:i,uploadFormRef:p,isError:s,extension:f,multiple:w,size:x,handleImport:(k,O=!1,c)=>{var r,l,n,m;if(u&&!h())return;const g=o.find(v=>v.bizCode===k&&v.isError===O);s.value=O,f.value=O?a:t,d.value=k,w.value=(r=g==null?void 0:g.multiple)!=null?r:!1,x.value=(l=g==null?void 0:g.size)!=null?l:1,(n=p.value)==null||n.setData({gridApi:c,isError:s.value,bizImportType:d.value}),(m=p.value)==null||m.open()},ImportSettingButton:()=>Se(Qe,{bizImportTypeList:i.value})}}export{nt as _,ct as u};
